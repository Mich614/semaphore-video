- name: Simulate VM Creation
  hosts: localhost
  gather_facts: false
  vars:
    vm_name: "AnsibleDeployedMachine10Test1"
    user_data_path: "/home/gruppe2/AnsibleDeployments/user-data"
    meta_data_path: "/home/gruppe2/AnsibleDeployments/meta-data"
    iso_path: "/home/gruppe2/AnsibleDeployments/cloud-init.iso"
    esxi_iso_path: "/vmfs/volumes/Datastore/Ansible/Cloud/cloud-init.iso"

  tasks:
    - name: Generate meta-data file dynamically
      ansible.builtin.copy:
        dest: "{{ meta_data_path }}"
        content: |
          instance-id: "{{ vm_name }}"
          local-hostname: "{{ vm_name }}"

    - name: Create Cloud-Init ISO
      ansible.builtin.shell:
        cmd: >
          genisoimage -output "{{ iso_path }}"
          -volid cidata -joliet -rock
          "{{ user_data_path }}" "{{ meta_data_path }}"
      args:
        executable: /bin/bash

    - name: Ensure target directory exists on ESXi server
      ansible.builtin.shell:
        cmd: ssh root@192.168.20.10 "mkdir -p /vmfs/volumes/Datastore/Ansible/Cloud"
      args:
        executable: /bin/bash

    - name: Transfer Cloud-Init ISO to ESXi server
      ansible.builtin.shell:
        cmd: scp "{{ iso_path }}" root@192.168.20.10:"{{ esxi_iso_path }}"
      args:
        executable: /bin/bash

    - name: Verify Cloud-Init ISO on ESXi server
      ansible.builtin.shell:
        cmd: ssh root@192.168.20.10 "ls -l {{ esxi_iso_path }}"
      register: verification_result
      args:
        executable: /bin/bash

    - name: Display verification result
      ansible.builtin.debug:
        var: verification_result.stdout
